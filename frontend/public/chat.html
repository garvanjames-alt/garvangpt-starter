<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <title>Almost Human — Chat</title>
  <style>
    :root{color-scheme:dark light}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,
      Cantarell,"Helvetica Neue",Arial,sans-serif; background:#0e0e0f; color:#f2f2f3;
    }
    .wrap{max-width:880px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; gap:12px; margin-bottom:16px}
    h1{font-size:28px; margin:0}
    .card{
      background:#17181a; border:1px solid #26282c; border-radius:12px;
      padding:16px; margin:12px 0;
    }
    textarea, input[type="text"]{
      width:100%; box-sizing:border-box; background:#101114; color:#e9eaec;
      border:1px solid #2a2d33; border-radius:10px; padding:12px; outline:none;
    }
    textarea::placeholder{color:#6f7683}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      appearance:none; border:0; border-radius:10px; padding:10px 16px;
      background:#4c6ef5; color:white; font-weight:600; cursor:pointer;
    }
    button[disabled]{opacity:0.6; cursor:not-allowed}
    small.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#aab2c0}
    .note{color:#aab2c0}
    /* persistent audio for autoplay fallback */
    #ttsAnswerAudio{
      position:fixed; left:16px; bottom:16px; z-index:100001;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Almost Human — Chat</h1>
    </header>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <strong>Talk to Almost Human</strong>
          <div class="note">Press “Ask” to fetch an answer and read it aloud (Australian voice).</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <label for="devQuestion"><strong>Question (dev-only)</strong></label>
      </div>
      <textarea id="devQuestion" rows="2" placeholder="Ask anything about health & medicines…">what is amoxicillin?</textarea>
      <div class="row" style="margin-top:10px">
        <label class="note"><input id="readAloud" type="checkbox" checked /> Read aloud (ElevenLabs)</label>
        <button id="askBtn">Ask</button>
        <small class="mono" id="status"></small>
      </div>
    </div>

    <div class="card" id="answerCard" style="display:none">
      <div><strong>Assistant</strong></div>
      <div id="answerText" class="note" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
  (() => {
    const $ = (sel, root=document) => root.querySelector(sel);
    const askBtn = $('#askBtn');
    const qInput = $('#devQuestion');
    const readAloud = $('#readAloud');
    const statusEl = $('#status');
    const answerCard = $('#answerCard');
    const answerText = $('#answerText');

    // Ensure there is a persistent <audio> element for autoplay fallback
    let audio = document.getElementById('ttsAnswerAudio');
    if (!audio) {
      audio = document.createElement('audio');
      audio.id = 'ttsAnswerAudio';
      audio.controls = true;
      document.body.appendChild(audio);
    }

    function setStatus(msg){ statusEl.textContent = msg || ''; }

    askBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      askBtn.disabled = true;
      setStatus('Asking…');

      const question = (qInput?.value || 'What is amoxicillin?').trim();
      if (!question) { setStatus(''); askBtn.disabled = false; return; }

      try {
        // 1) Ask backend for an answer
        const r1 = await fetch('/respond', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });
        const j1 = await r1.json();
        const answer = j1.answer || 'This is a test of the Australian voice.';
        console.log('[E2E] Answer:', answer);

        // Show in UI
        answerText.textContent = answer;
        answerCard.style.display = 'block';

        // 2) Optionally read it aloud
        if (readAloud.checked) {
          setStatus('Synthesizing…');
          const r2 = await fetch('/api/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: answer })
          });
          console.log('[E2E] TTS status:', r2.status, r2.headers.get('content-type'));
          const blob = await r2.blob();
          console.log('[E2E] TTS blob size:', blob.size);

          const url = URL.createObjectURL(blob);
          audio.src = url;
          audio.onended = () => URL.revokeObjectURL(url);

          try {
            await audio.play();
            console.log('[E2E] Playing answer…');
          } catch (autoplayErr) {
            console.warn('[E2E] Autoplay blocked:', autoplayErr);
            alert('Click the audio control (bottom–left) to play the answer.');
          }
        }

        setStatus('Done.');
      } catch (err) {
        console.error('[E2E] Error:', err);
        setStatus('Error — see console.');
        alert('Sorry — something went wrong. See console for details.');
      } finally {
        askBtn.disabled = false;
        setTimeout(() => setStatus(''), 1500);
      }
    });
  })();
  </script>
</body>
</html>
