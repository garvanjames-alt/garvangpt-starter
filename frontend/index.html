<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GarvanGPT — “Almost Human” (Local MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.45; padding: 24px; max-width: 900px; margin: 0 auto; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    small { color: #666; }
    textarea, input[type="text"] { width: 100%; box-sizing: border-box; font: inherit; padding: 10px; }
    textarea { min-height: 90px; }
    button { font: inherit; padding: 8px 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .stack { display: grid; gap: 10px; }
    .card { border: 1px solid #e5e5e5; border-radius: 6px; padding: 10px; background: #fafafa; }
    .label { font-weight: 600; }
    .muted { color: #777; }
    .error { color: #b00020; }
    .ok { color: #0a7a0a; }
    ul { margin: 8px 0; padding-left: 18px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .field { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <h1>GarvanGPT — “Almost Human” (Local MVP)</h1>
  <small>Backend at <span class="mono">3001</span>; Frontend at <span class="mono">5173</span>. API base via relative paths.</small>

  <!-- Dev-only Ask -->
  <div class="stack" style="margin-top:18px">
    <div class="label">Question (dev-only)</div>
    <textarea id="q" placeholder="what is amoxicillin"></textarea>
    <div class="row">
      <button id="askBtn" type="button">Ask</button>
      <label class="field">
        <input type="checkbox" id="speak" checked />
        <span>Read aloud (ElevenLabs)</span>
      </label>
      <span id="ttsErr" class="error" style="display:none">error</span>
    </div>
  </div>

  <!-- Prototype chat (optional) -->
  <div class="stack" style="margin-top:22px">
    <div class="label">Talk to the prototype</div>
    <textarea id="user" placeholder="Speak or type here…"></textarea>
    <div class="row">
      <button id="micBtn" type="button" disabled>Start mic</button>
      <button id="protoBtn" type="button">Send to prototype</button>
    </div>
  </div>

  <!-- Assistant output -->
  <div class="stack" style="margin-top:22px">
    <div class="label">Assistant</div>
    <textarea id="ans" placeholder="The answer will appear here…" readonly></textarea>
    <div class="row">
      <button id="copyBtn" type="button">Copy answer/transcript</button>
      <button id="downloadBtn" type="button">Download .txt</button>
    </div>
  </div>

  <!-- Memories -->
  <div class="stack" style="margin-top:22px">
    <div class="label">Memories</div>
    <div class="row">
      <button id="memLoad" type="button">Load</button>
      <button id="memClear" type="button">Clear all</button>
      <span id="memCount" class="muted">Memories (count: 0)</span>
      <span id="memErr" class="error" style="display:none">error</span>
    </div>
    <div class="row">
      <input id="memText" placeholder="Add a new memory…" />
      <button id="memAdd" type="button">Add</button>
    </div>
    <div id="memList" class="card" style="display:none"></div>
  </div>

  <script>
    // ------- Helpers -------
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const qEl       = $('#q');
    const ansEl     = $('#ans');
    const speakEl   = $('#speak');
    const ttsErrEl  = $('#ttsErr');
    const memCount  = $('#memCount');
    const memErr    = $('#memErr');
    const memText   = $('#memText');
    const memList   = $('#memList');

    function setTTSError(show, msg='error') {
      ttsErrEl.style.display = show ? '' : 'none';
      ttsErrEl.textContent = msg;
    }
    function setMemError(show, msg='error') {
      memErr.style.display = show ? '' : 'none';
      memErr.textContent = msg;
    }
    function setAns(text){ ansEl.value = text || ''; }

    // ------- /api/respond -------
    async function ask() {
      setTTSError(false);
      try {
        const question = (qEl.value || '').trim();
        if (!question) return;

        const r = await fetch('/api/respond', {
          method: 'POST',
          headers: { 'content-type':'application/json' },
          body: JSON.stringify({ question })
        });
        if (!r.ok) throw new Error('respond ' + r.status);
        const data = await r.json();
        const text = data?.text || data?.answer || '(no text)';
        setAns(text);

        if (speakEl.checked) {
          try {
            const tts = await fetch('/api/tts', {
              method: 'POST',
              headers: { 'content-type':'application/json' },
              body: JSON.stringify({ text })
            });
            if (tts.status === 204) {
              // stub/no-op
            } else if (tts.ok) {
              const ct = tts.headers.get('content-type') || '';
              if (!ct.startsWith('audio/')) throw new Error('invalid TTS content-type: ' + ct);
              const blob = await tts.blob();
              if (blob.size > 0) {
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.play().catch(console.warn);
              }
            } else {
              throw new Error('tts ' + tts.status);
            }
          } catch (e) {
            console.error('TTS error', e);
            setTTSError(true, 'error');
          }
        }
      } catch (e) {
        console.error('ask error', e);
        setAns('(error) ' + (e?.message || e));
      }
    }

    // ------- Memory API (/api/memory) -------
    async function loadMem() {
      setMemError(false);
      try {
        const r = await fetch('/api/memory');
        const data = await r.json();
        const items = Array.isArray(data?.items) ? data.items : [];
        memCount.textContent = `Memories (count: ${items.length})`;
        if (items.length) {
          memList.style.display = '';
          memList.innerHTML = '<div class="label">Items</div><ul>' + items
            .map(m => `<li>${escapeHtml(m.text)} <span class="muted">(${m.ts})</span></li>`)
            .join('') + '</ul>';
        } else {
          memList.style.display = 'none';
          memList.innerHTML = '';
        }
      } catch (e) {
        console.error('loadMem error', e);
        setMemError(true, 'error');
      }
    }

    async function addMem() {
      setMemError(false);
      try {
        const text = (memText.value || '').trim();
        if (!text) return;
        const r = await fetch('/api/memory', {
          method: 'POST',
          headers: { 'content-type':'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await r.json();
        if (!data?.ok) throw new Error('add failed');
        memText.value = '';
        await loadMem();
      } catch (e) {
        console.error('addMem error', e);
        setMemError(true, 'error');
      }
    }

    async function clearMem() {
      setMemError(false);
      try {
        const r = await fetch('/api/memory', { method: 'DELETE' });
        const data = await r.json();
        if (!data?.ok) throw new Error('clear failed');
        await loadMem();
      } catch (e) {
        console.error('clearMem error', e);
        setMemError(true, 'error');
      }
    }

    // ------- Download / Copy -------
    function copyAns() {
      try {
        navigator.clipboard.writeText(ansEl.value || '');
      } catch (e) { console.warn(e); }
    }
    function dlTxt() {
      const blob = new Blob([ansEl.value || ''], { type: 'text/plain' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = 'answer.txt';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ------- Events -------
    $('#askBtn').addEventListener('click', (e) => { e.preventDefault(); ask(); });
    $('#protoBtn').addEventListener('click', (e) => { e.preventDefault(); /* prototype hook */ });
    $('#copyBtn').addEventListener('click', (e) => { e.preventDefault(); copyAns(); });
    $('#downloadBtn').addEventListener('click', (e) => { e.preventDefault(); dlTxt(); });

    $('#memLoad').addEventListener('click',  (e) => { e.preventDefault(); loadMem(); });
    $('#memAdd').addEventListener('click',   (e) => { e.preventDefault(); addMem(); });
    $('#memClear').addEventListener('click', (e) => { e.preventDefault(); clearMem(); });

    // Helpers
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    // Initial
    loadMem();
  </script>
</body>
</html>
