<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Almost Human — Chat</title>
  <meta name="description" content="Almost Human — Avatar Chat" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#10151c;
      --panel-2:#0f141b;
      --text:#e6eef8;
      --muted:#9fb2c3;
      --brand:#00d4ff;
      --accent:#1a2430;
      --border:#182029;
      --ok:#00c27a;
      --warn:#ffb020;
      --err:#f55a6a;
      --pill:#2a3340;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
    }
    a{ color:var(--brand); text-decoration:none; }

    /* Header */
    header{
      position:sticky; top:0; z-index: 10;
      background: linear-gradient(180deg, rgba(16,21,28,0.95), rgba(16,21,28,0.75));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
    }
    header .wrap{ max-width:1080px; margin: 0 auto; padding: 14px 16px; }
    header .row{ display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap: wrap; }
    header .left, header .right{ display:flex; align-items:center; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .brand .logo{
      width:28px; height:28px; border-radius:10px; display:grid; place-items:center;
      background: radial-gradient(120% 120% at 10% -10%, #19b5ff, #5f7fff 50%, #141a22 80%);
      color:#00131d; font-weight:900;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.35) inset, 0 2px 10px rgba(0,0,0,0.35);
    }
    .subtitle{ color:var(--muted); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px; background:var(--pill);
      border:1px solid rgba(255,255,255,0.06); color:var(--text); font-weight:700;
    }
    .env{ background:#2a3f4d; }
    .login{ background:#193827; color:#c6ffe8; }
    .volume{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); }
    .volume label{ color:var(--muted); font-weight:700; }
    input[type="range"]{
      -webkit-appearance:none; appearance:none; height:8px; width:170px; border-radius:999px;
      background: linear-gradient(90deg, #72d1ff, #80e4ff);
      outline:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none; width:22px; height:22px; border-radius:50%;
      background:#7ad3ff; border:3px solid #a9e5ff; box-shadow:0 2px 10px rgba(0,0,0,.35);
      cursor:pointer; margin-top:-7px;
    }

    /* The avatar bubble next to brand */
    #brandVoiceGroup{ display:inline-flex; align-items:center; gap:12px; }
    #brandAvatarClone{
      width:56px; height:56px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; font-weight:800; letter-spacing:.5px;
      background:rgba(0,0,0,0.25);
      border:2px solid rgba(255,255,255,0.12);
      box-shadow:0 0 0 2px rgba(0,0,0,0.25) inset;
    }
    #headerAvatarLabel{ font-weight:700; opacity:.8; }

    main{ max-width:1080px; margin:18px auto 28px auto; padding:0 16px; }

    .welcome{
      background:linear-gradient(180deg, rgba(16,21,28,.7), rgba(16,21,28,.35));
      border:1px solid var(--border); border-radius:16px; padding:26px; text-align:center; color:var(--muted);
    }
    .welcome h2{ margin:0 0 8px 0; color:var(--text); }

    /* Chat bubbles */
    .log{ display:flex; flex-direction:column; gap:16px; margin:20px 0 110px 0; }
    .bubble{
      background:var(--panel); border:1px solid var(--border);
      padding:16px 18px; border-radius:14px; max-width:900px;
      position:relative;
    }
    .bubble.you{ background:#0f1217; border-color:#0f1a25; }
    .rowline{ display:flex; align-items:flex-start; gap:10px; }
    .avatar{
      width:34px; height:34px; border-radius:999px; display:grid; place-items:center;
      font-weight:800; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
    }
    .role{ color:var(--muted); font-size:.9rem; margin-bottom:6px; }
    .actions{ position:absolute; top:50%; transform:translateY(-50%); right:-56px; display:flex; gap:8px; }
    .btn{
      width:44px; height:44px; display:grid; place-items:center; border-radius:12px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,.08); }
    .btn:disabled{ opacity:.5; cursor:default; }
    .btn svg{ width:18px; height:18px; }

    /* Composer */
    .composer{
      position:fixed; left:0; right:0; bottom:0; z-index:5;
      background:linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,.8));
      padding:18px 16px 18px 16px; border-top:1px solid var(--border);
    }
    .composer .wrap{ max-width:1080px; margin:0 auto; display:flex; gap:10px; }
    textarea{
      flex:1; resize:none; min-height:50px; max-height:200px;
      border-radius:14px; border:1px solid var(--border);
      background:var(--panel-2); color:var(--text); padding:14px 14px;
      outline:none;
    }
    .send{
      min-width:78px; border:none; border-radius:14px; padding:0 18px; font-weight:800;
      background:#1ec9ff; color:#00131d; box-shadow: 0 2px 10px rgba(0,0,0,.35);
      cursor:pointer;
    }
    .send:disabled{ opacity:.6; cursor:default; }
    .badge{ padding:6px 10px; border-radius:999px; font-weight:800; font-size:.85rem; }
    .badge.staging{ background:#2a3f4d; color:#cfefff; border:1px solid rgba(255,255,255,.06); }
    .badge.ok{ background:#0b3; color:#001; }
    .badge.warn{ background:#845a00; color:#fff3d6; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="left">
          <div class="brand">
            <div class="logo">AH</div>
            <div>
              <div style="font-weight:900">Almost Human</div>
              <div class="subtitle">— now in preview</div>
            </div>
          </div>

          <!-- Avatar group lives next to brand -->
          <span id="brandVoiceGroup">
            <span id="brandAvatarClone">AH</span>
            <span id="headerAvatarLabel">Avatar</span>
          </span>

          <span class="pill env">STAGING</span>
          <span class="pill login">Logged in</span>
        </div>

        <div class="right">
          <div class="volume" title="Playback volume">
            <label for="volumeRange">Voice</label>
            <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="1" />
            <span id="volPct">100%</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div id="welcome" class="welcome">
      <h2>Welcome to Almost Human</h2>
      <div>Say hello! <b>Enter</b> to send, <b>Shift+Enter</b> for a new line.</div>
      <div style="margin-top:8px;">You may need to <a href="/admin-panel.html" target="_blank">log in</a> first if you see a 401.</div>
    </div>

    <div id="log" class="log" aria-live="polite"></div>
  </main>

  <div class="composer">
    <div class="wrap">
      <textarea id="msg" placeholder="Write a message…"></textarea>
      <button id="send" class="send">Send</button>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const BACKEND = 'https://almosthuman-starter-staging.onrender.com';
    const RESPOND_URL = BACKEND + '/api/respond';
    const TTS_URL = BACKEND + '/api/tts';

    // ===== UTIL =====
    const $ = sel => document.querySelector(sel);
    const logEl = $('#log'), msgEl = $('#msg'), sendEl = $('#send');
    const welcome = $('#welcome');
    const vol = $('#volumeRange'), volPct = $('#volPct');
    let currentAudio = null;

    vol.addEventListener('input', () => {
      volPct.textContent = Math.round(vol.value * 100) + '%';
      if (currentAudio) currentAudio.volume = +vol.value;
    });

    function addBubble(role, text){
      welcome.style.display = 'none';
      const wrap = document.createElement('div');

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'you' ? 'you' : 'assistant');

      const head = document.createElement('div');
      head.className = 'role';
      head.textContent = role === 'you' ? 'You' : 'Assistant';

      const row = document.createElement('div');
      row.className = 'rowline';

      const av = document.createElement('div');
      av.className = 'avatar';
      av.textContent = role === 'you' ? 'You' : 'AH';

      const body = document.createElement('div');
      body.className = 'content';
      body.textContent = text;

      row.appendChild(av);
      row.appendChild(body);
      bubble.appendChild(head);
      bubble.appendChild(row);

      if (role === 'assistant'){
        const actions = document.createElement('div'); actions.className='actions';

        const play = document.createElement('button'); play.className='btn'; play.title='Play audio';
        play.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;

        const stop = document.createElement('button'); stop.className='btn'; stop.title='Stop audio';
        stop.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"></rect></svg>`;

        play.addEventListener('click', () => speak(body.textContent, play));
        stop.addEventListener('click', () => { if (currentAudio) { currentAudio.pause(); currentAudio = null; } });

        actions.appendChild(play); actions.appendChild(stop);
        bubble.appendChild(actions);
      }

      wrap.appendChild(bubble);
      logEl.appendChild(wrap);
      bubble.scrollIntoView({behavior:'smooth', block:'end'});
      return { bubble, wrap };
    }

    async function speak(text, btn){
      if (!text || !text.trim()) return;
      btn && (btn.disabled = true);
      try{
        const res = await fetch(TTS_URL, {
          method:'POST',
          credentials:'include',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ text })
        });
        // 204 = TTS not configured — gracefully no-op
        if (res.status === 204) return;
        if (!res.ok) {
          console.warn('[TTS] Non-OK', res.status);
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        if (currentAudio) currentAudio.pause();
        currentAudio = new Audio(url);
        currentAudio.volume = +vol.value;
        currentAudio.play().catch(()=>{});
      } finally {
        btn && (btn.disabled = false);
      }
    }

    async function askBackend(question){
      const res = await fetch(RESPOND_URL, {
        method:'POST',
        credentials:'include',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ question })
      });
      if (res.status === 401) {
        addBubble('assistant', '401 Unauthorized — please log in on the admin panel, then try again.');
        return '';
      }
      if (!res.ok) {
        let why = '';
        try { why = await res.text(); } catch {}
        addBubble('assistant', `HTTP ${res.status} — ${why || 'Request failed'}`);
        return '';
      }
      const data = await res.json();
      return data.answer || '';
    }

    async function onSend(){
      const q = msgEl.value.trim();
      if (!q) return;
      sendEl.disabled = true;
      msgEl.value = '';
      addBubble('you', q);
      const a = await askBackend(q || '');
      if (a) addBubble('assistant', a);
      sendEl.disabled = false;
      msgEl.focus();
    }

    msgEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        onSend();
      }
    });
    sendEl.addEventListener('click', onSend);

    // ===== Header avatar stabilization (single AH next to brand) =====
    (function stabilizeHeaderAvatar(){
      const row   = document.querySelector('header .wrap .row');
      const left  = row?.querySelector('.left');
      const brand = left?.querySelector('.brand');
      if (!row || !left || !brand) return;

      let grp = document.getElementById('brandVoiceGroup');
      if (!grp) {
        grp = document.createElement('span');
        grp.id = 'brandVoiceGroup';
        grp.style.display = 'inline-flex';
        grp.style.alignItems = 'center';
        grp.style.gap = '12px';
      }

      let clone = document.getElementById('brandAvatarClone');
      if (!clone) {
        clone = document.createElement('span');
        clone.id = 'brandAvatarClone';
        clone.textContent = 'AH';
      }
      let label = document.getElementById('headerAvatarLabel');
      if (!label) {
        label = document.createElement('span');
        label.id = 'headerAvatarLabel';
      }
      label.textContent = 'Avatar';

      grp.replaceChildren(clone, label);

      // Insert right after brand
      const afterBrand = brand.nextSibling;
      if (afterBrand) left.insertBefore(grp, afterBrand); else left.appendChild(grp);

      // Hide any stray right-side AH (if present from older markup)
      try{
        const header = document.querySelector('header');
        const badges = [...header.querySelectorAll('*')].filter(el => el.textContent?.trim() === 'AH');
        if (badges.length >= 2) {
          const rightmost = badges.reduce((a,b)=>(
            b.getBoundingClientRect().x > a.getBoundingClientRect().x ? b : a
          ));
          if (rightmost !== clone) rightmost.style.display = 'none';
        }
      }catch(_){}
    })();
  </script>
</body>
</html>
