<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GarvanGPT Admin Panel — Step 87</title>
  <style>
    :root { --gap: 14px; --radius: 16px; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; background: #0b0c10; color: #e6edf3; }
    header { padding: 20px; border-bottom: 1px solid #1f2329; background: #0e1116; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0 0 4px; font-size: 20px; }
    .sub { opacity: .8; font-size: 13px; }
    main { padding: 20px; display: grid; gap: var(--gap); grid-template-columns: 1fr; max-width: 1100px; margin: 0 auto; }
    .card { background: #0e1116; border: 1px solid #1f2329; border-radius: var(--radius); padding: 16px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .row > *:not(:last-child) { margin-right: 8px; }
    label { display: block; font-size: 12px; opacity: .8; margin-bottom: 6px; }
    input, textarea, select { width: 100%; background: #0b0c10; color: #e6edf3; border: 1px solid #30363d; padding: 10px 12px; border-radius: 10px; }
    input::placeholder, textarea::placeholder { color: #9da7b1; }
    button { background: #1f6feb; color: white; border: 0; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    button.secondary { background: #30363d; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .grid { display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    pre { background: #0b0c10; border: 1px solid #30363d; padding: 12px; border-radius: 12px; max-height: 360px; overflow: auto; }
    .muted { opacity: .7; }
    .success { color: #3fb950; }
    .danger { color: #f85149; }
    footer { padding: 18px 20px 40px; opacity: .8; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>GarvanGPT Admin Panel</h1>
    <div class="sub">Step 87: Wire frontend → backend with cookies (Render → Render)</div>
  </header>
  <main>
    <section class="card">
      <div class="grid">
        <div>
          <label for="apiBase">Backend Base URL</label>
          <input id="apiBase" value="https://almosthuman-starter-staging.onrender.com" />
        </div>
        <div>
          <label for="username">Username</label>
          <input id="username" placeholder="garvan" value="garvan" />
        </div>
        <div>
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="your-admin-password" />
        </div>
      </div>
      <div style="height: 10px"></div>
      <div class="row">
        <div class="muted">Calls use <code>credentials:'include'</code> and full HTTPS URLs.</div>
        <div style="display:flex; gap:8px;">
          <button id="btnHealth" class="secondary">Health</button>
          <button id="btnLogin">Login (set cookie)</button>
          <button id="btnPing" class="secondary">Admin Ping</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div>
          <label>Memory (GET)</label>
          <button id="btnMemGet" class="secondary" style="width:100%">Fetch Memory</button>
        </div>
        <div>
          <label for="memText">Add Memory (POST)</label>
          <div class="row">
            <input id="memText" placeholder="text to store…" />
            <button id="btnMemPost">Add</button>
          </div>
        </div>
        <div>
          <label>Clear Memory (DELETE)</label>
          <button id="btnMemClear" class="secondary" style="width:100%">Delete All</button>
        </div>
      </div>
    </section>

    <section class="card">
      <label for="ask">Respond (proxy LLM)</label>
      <div class="row">
        <input id="ask" placeholder="Say hello from staging and tell me the environment name." />
        <button id="btnRespond">Send</button>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <div class="muted">Output</div>
        <div style="display:flex; gap:8px;">
          <button id="btnClear" class="secondary">Clear Output</button>
          <button id="btnCopy" class="secondary">Copy</button>
        </div>
      </div>
      <pre id="out" aria-live="polite">Ready.
</pre>
    </section>
  </main>
  <footer class="muted">
    If you see <span class="success">200 OK</span> for <em>Admin Ping</em> and can read/add memory, cookies and CORS are correct.
  </footer>

<script>
const $ = (id) => document.getElementById(id);
const out = $("out");
const log = (label, data, isError=false) => {
  const time = new Date().toISOString();
  const line = `[${time}] ${label}: ${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}`;
  out.textContent += line + "\n";
  out.scrollTop = out.scrollHeight;
  if(isError) console.error(label, data); else console.log(label, data);
};
const api = () => $("apiBase").value.replace(/\/$/, "");

async function go(path, opts={}) {
  const url = api() + path;
  const res = await fetch(url, { credentials: 'include', ...opts });
  const ct = res.headers.get('content-type') || '';
  let body = null;
  try { body = ct.includes('application/json') ? await res.json() : await res.text(); }
  catch(e) { body = await res.text().catch(()=>'<no body>'); }
  return { ok: res.ok, status: res.status, url, body, headers: Object.fromEntries(res.headers.entries()) };
}

$("btnHealth").onclick = async () => {
  const r = await go('/health');
  log('HEALTH', r);
};

$("btnLogin").onclick = async () => {
  const username = $("username").value;
  const password = $("password").value;
  const r = await go('/api/login', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ username, password })
  });
  const setCookie = r.headers['set-cookie'] || '<HttpOnly; not visible to JS>';
  log('LOGIN', { status: r.status, hasCookieHeader: Boolean(setCookie), body: r.body });
};

$("btnPing").onclick = async () => {
  const r = await go('/api/admin/ping');
  log('ADMIN PING', r);
};

$("btnMemGet").onclick = async () => {
  const r = await go('/api/memory');
  log('MEMORY GET', r);
};

$("btnMemPost").onclick = async () => {
  const text = $("memText").value || 'added via admin panel';
  const r = await go('/api/memory', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ text })
  });
  log('MEMORY POST', r);
};

$("btnMemClear").onclick = async () => {
  const r = await go('/api/memory', { method: 'DELETE' });
  log('MEMORY DELETE', r);
};

// ✅ FIX: send {question} instead of {input}
$("btnRespond").onclick = async () => {
  const question = $("ask").value || 'Say hello from staging and tell me the environment name.';
  const r = await go('/api/respond', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ question })
  });
  log('RESPOND', r);
};

$("btnClear").onclick = () => { out.textContent = ''; };
$("btnCopy").onclick = async () => {
  try { await navigator.clipboard.writeText(out.textContent); log('COPY', 'Output copied to clipboard.'); }
  catch (e) { log('COPY', 'Clipboard write failed', true); }
};
</script>
</body>
</html>
